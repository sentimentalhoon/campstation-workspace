# ================================
# CampStation - Nginx Production Configuration (HTTP Only - Simple)
# ================================
# Docker 컨테이너 기반 배포용 Nginx 설정 (SSL 적용 전)
# 
# 배포 위치: Docker 컨테이너 내부 /etc/nginx/conf.d/default.conf
# 
# HTTP만 사용 (포트 80)
# SSL 적용 후에는 campstation-prod.conf 사용 권장
# ================================

# ================================
# Rate Limiting 설정
# ================================
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=200r/s;

# ================================
# Upstream 정의
# ================================
upstream frontend_upstream {
    server campstation-frontend:3000;
    keepalive 32;
}

upstream backend_upstream {
    server campstation-backend:8080;
    keepalive 32;
}

upstream minio_api_upstream {
    server campstation-minio:9000;
    keepalive 32;
}

upstream minio_console_upstream {
    server campstation-minio:9001;
    keepalive 32;
}

# ================================
# Main Server (HTTP Only)
# ================================
server {
    listen 80;
    listen [::]:80;
    server_name mycamp.duckdns.org www.mycamp.duckdns.org _;

    # 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # 클라이언트 업로드 제한
    client_max_body_size 50M;
    client_body_buffer_size 10M;

    # 타임아웃 설정
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    send_timeout 300s;

    # 버퍼 설정
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;

    # 공통 프록시 헤더
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # ================================
    # API 라우팅 (/api/*)
    # ================================
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;

        proxy_pass http://backend_upstream/api/;
        
        # WebSocket 지원
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 긴 요청 타임아웃 (파일 업로드 등)
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # ================================
    # 파일 업로드 (/api/upload/*)
    # ================================
    location /api/upload/ {
        limit_req zone=upload_limit burst=10 nodelay;
        
        proxy_pass http://backend_upstream/api/upload/;
        
        # 파일 업로드 타임아웃
        client_max_body_size 50M;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }

    # ================================
    # Actuator (헬스체크)
    # ================================
    location /actuator/ {
        proxy_pass http://backend_upstream/actuator/;
        
        # 내부 네트워크만 허용 (선택사항)
        # allow 192.168.0.0/16;
        # allow 172.16.0.0/12;
        # allow 10.0.0.0/8;
        # deny all;
    }

    # ================================
    # MinIO API (/minio/*)
    # ================================
    location /minio/ {
        limit_req zone=api_limit burst=50 nodelay;
        
        # /minio/ 제거하고 MinIO로 전달
        rewrite ^/minio/(.*) /$1 break;
        proxy_pass http://minio_api_upstream;
        
        # MinIO 전용 헤더
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
        
        # 청크 인코딩 지원
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
    }

    # ================================
    # MinIO Console (/minio-console/*)
    # ================================
    location /minio-console/ {
        # 내부 네트워크만 허용 (선택사항)
        # allow 192.168.0.0/16;
        # deny all;
        
        # /minio-console/ 제거하고 Console로 전달
        rewrite ^/minio-console/(.*) /$1 break;
        proxy_pass http://minio_console_upstream;
        
        # WebSocket 지원
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ================================
    # Next.js Static Files
    # ================================
    location /_next/static/ {
        proxy_pass http://frontend_upstream;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, immutable";
    }

    location /_next/image {
        proxy_pass http://frontend_upstream;
        proxy_cache_valid 200 7d;
    }

    # ================================
    # Frontend (나머지 모든 경로)
    # ================================
    location / {
        limit_req zone=general_limit burst=100 nodelay;
        
        proxy_pass http://frontend_upstream;
        
        # Next.js SSR 지원
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ================================
    # 에러 페이지
    # ================================
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        return 502 "Service Temporarily Unavailable";
        add_header Content-Type text/plain;
    }
}

# ================================
# 로깅 설정
# ================================
log_format main_ext '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

access_log /var/log/nginx/access.log main_ext;
error_log /var/log/nginx/error.log warn;
