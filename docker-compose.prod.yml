# ================================
# CampStation - Production Docker Compose
# ================================
# DDNS 기반 프로덕션 배포 설정
# 사용법: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# 필수: .env.prod 파일 생성 및 설정
# ================================

services:
  # ================================
  # Frontend (Next.js) - Production
  # ================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: runtime
      args:
        - NODE_ENV=production
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://mycamp.duckdns.org}
        - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-CampStation}
        - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-1.0.0}
        - NEXT_PUBLIC_KAKAO_MAP_API_KEY=${NEXT_PUBLIC_KAKAO_MAP_API_KEY}
        - NEXT_PUBLIC_TOSS_CLIENT_KEY=${NEXT_PUBLIC_TOSS_CLIENT_KEY}
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://mycamp.duckdns.org}
      - NEXT_TELEMETRY_DISABLED=1
      # SSR에서 Backend 접근용 (Docker 네트워크 내부)
      - INTERNAL_API_URL=http://campstation-backend:8080
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-CampStation}
      - NEXT_PUBLIC_APP_VERSION=${NEXT_PUBLIC_APP_VERSION:-1.0.0}
      - NEXT_PUBLIC_KAKAO_MAP_API_KEY=${NEXT_PUBLIC_KAKAO_MAP_API_KEY}
      - NEXT_PUBLIC_TOSS_CLIENT_KEY=${NEXT_PUBLIC_TOSS_CLIENT_KEY}
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ================================
  # Backend (Spring Boot) - Production
  # ================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: runtime
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SERVER_PORT=8080

      # Database
      - DB_URL=${DB_URL:-jdbc:postgresql://db:5432/campstation}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_POOL_SIZE=${DB_POOL_SIZE:-20}

      # Redis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}

      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-3600000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-604800000}

      # CORS
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}

      # S3/MinIO
      - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME}
      - AWS_REGION=${AWS_S3_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_S3_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_S3_SECRET_ACCESS_KEY}
      - CLOUD_AWS_S3_ENDPOINT=${AWS_S3_ENDPOINT:-http://campstation-minio:9000}
      - CLOUD_AWS_S3_EXTERNAL_ENDPOINT=${AWS_S3_EXTERNAL_ENDPOINT:-http://campstation-minio:9000}
      - CLOUD_AWS_S3_PUBLIC_ENDPOINT=${AWS_S3_PUBLIC_ENDPOINT:-https://mycamp.duckdns.org/storage}

      # OAuth2
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - NAVER_CLIENT_ID=${NAVER_CLIENT_ID}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}

      # Email
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
      - MAIL_PORT=${MAIL_PORT:-587}

      # Admin
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ADMIN_EMAIL=${ADMIN_EMAIL}

      # Logging
      - LOGGING_LEVEL_ROOT=${LOGGING_LEVEL_ROOT:-WARN}
      - LOGGING_LEVEL_COM_CAMPSTATION=${LOGGING_LEVEL_COM_CAMPSTATION:-INFO}

      # Toss Payments
      - TOSS_SECRET_KEY=${TOSS_SECRET_KEY}
      - TOSS_CLIENT_KEY=${TOSS_CLIENT_KEY}
    restart: always
    logging:
      driver: "json-file"

  # ================================
  # Nginx Reverse Proxy - Production
  # ================================
  nginx:
    image: nginx:alpine
    container_name: campstation-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # HTTP-only config (SSL 설정 전)
      # - ./infrastructure/nginx/campstation-prod-simple.conf:/etc/nginx/conf.d/default.conf:ro
      # SSL 적용 버전
      - ./infrastructure/nginx/campstation-prod.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    depends_on:
      - frontend
      - backend
    networks:
      - campstation-network
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ================================
  # Database (PostgreSQL) - Production
  # ================================
  db:
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=${DB_USERNAME}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ================================
  # Redis - Production
  # ================================
  redis:
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --maxmemory ${REDIS_MAXMEMORY:-512mb}
      --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
    volumes:
      - redis_data_prod:/data
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ================================
  # MinIO (S3 Compatible Storage) - Production
  # ================================
  minio:
    image: minio/minio:latest
    container_name: ${COMPOSE_PROJECT_NAME:-campstation}-minio
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data_prod:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_REGION=${AWS_S3_REGION:-us-east-1}
      - MINIO_DOMAIN=${MINIO_DOMAIN}
      - MINIO_SERVER_URL=${MINIO_SERVER_URL}
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_REDIRECT_URL}
      - MINIO_API_REQUESTS_MAX=1000
      - MINIO_API_REQUESTS_DEADLINE=1m
    command: server /data --console-address ":9001" --address ":9000"
    networks:
      - campstation-network
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ================================
  # MinIO Client (mc) - Bucket Setup
  # ================================
  minio-setup:
    image: minio/mc:latest
    container_name: ${COMPOSE_PROJECT_NAME:-campstation}-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - campstation-network
    entrypoint: >
      /bin/sh -c "
        mc alias set campstation http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} &&
        mc mb campstation/${AWS_S3_BUCKET_NAME} --ignore-existing &&
        mc anonymous set ${MINIO_BUCKET_POLICY:-download} campstation/${AWS_S3_BUCKET_NAME} &&
        echo 'MinIO production bucket setup completed'
      "
    deploy:
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3

# ================================
# Volumes (Production)
# ================================
volumes:
  postgres_data_prod:
    driver: local
  redis_data_prod:
    driver: local
  minio_data_prod:
    driver: local
  backend_logs:
    driver: local
  backend_uploads:
    driver: local
