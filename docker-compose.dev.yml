# ================================
# Development Environment Override
# 로컬 개발환경: 프론트엔드는 보통 로컬에서 실행 (npm run dev),
# 필요 시만 컨테이너로 띄움. 백엔드와 Redis, MailHog는 Docker로 관리.
# ================================
services:
  # -------------------------------
  # Frontend (Next.js)
  # -------------------------------
  frontend:
    profiles:
      - frontend-docker # 기본적으로는 실행하지 않음 (옵션 실행용)
    build:
      context: ./frontend # 프론트엔드 소스 경로
      dockerfile: Dockerfile.dev # 개발용 Dockerfile
    ports:
      - "3000:3000" # 호스트:컨테이너 포트 매핑
    volumes:
      - ./frontend:/app # 코드 변경 시 실시간 반영
      - /app/node_modules # node_modules는 컨테이너 내부 유지
    networks:
      - campstation-network
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api # 브라우저에서 접근할 API URL
      - NEXT_PUBLIC_KAKAO_MAP_API_KEY=${KAKAO_MAP_API_KEY:-your-kakao-map-api-key-here}
      - BACKEND_URL=http://localhost:8080 # 백엔드 API 주소

  # -------------------------------
  # Redis (Cache)
  # -------------------------------
  redis:
    container_name: campstation-redis
    hostname: redis # 명시적으로 hostname 지정 (Spring Boot에서 redis로 접근 가능)
    networks:
      - campstation-network
    environment:
      - REDIS_MAXMEMORY=256mb # 최대 메모리 제한
      - REDIS_MAXMEMORY_POLICY=allkeys-lru # 메모리 정책 (LRU 기반)
    command: redis-server --protected-mode no --bind 0.0.0.0 # 외부 접근 허용 (개발 편의용)
    healthcheck:
      test: ["CMD", "redis-cli", "ping"] # Redis 상태 확인
      interval: 1s
      timeout: 3s
      retries: 5
      start_period: 5s

  # -------------------------------
  # Backend (Spring Boot - Dev Mode)
  # -------------------------------
  backend:
    environment:
      - SPRING_PROFILES_ACTIVE=dev # 개발 프로파일 활성화
      - SHOW_SQL=true # SQL 로그 출력
      - FORMAT_SQL=true # SQL 포맷팅
      - LOG_LEVEL=DEBUG # 로깅 레벨
      # Redis 연결 정보
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_REDIS_TIMEOUT=2000ms
      # DB (H2 인메모리)
      - DB_URL=jdbc:h2:mem:campstation;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
      - DB_DRIVER=org.h2.Driver
      - DB_USERNAME=sa
      - DB_PASSWORD=
      # JWT & CORS
      - JWT_SECRET=campstation-dev-secret-key-this-is-only-for-development-environment-please-change-in-production
      - CORS_ALLOWED_ORIGINS=http://localhost:3000
      # Mail (MailHog 연결)
      - SPRING_MAIL_HOST=mailhog
      - SPRING_MAIL_PORT=1025
      - SPRING_MAIL_USERNAME=
      - SPRING_MAIL_PASSWORD=
    volumes:
      - ./backend/src:/app/src # 코드 변경 시 실시간 반영
      - ./backend/uploads:/app/uploads # 업로드 파일 저장소
    depends_on:
      redis:
        condition: service_healthy # Redis가 정상 실행된 후 시작
      mailhog:
        condition: service_started # MailHog가 실행된 후 시작
    networks:
      - campstation-network

  # -------------------------------
  # MailHog (SMTP 테스트 서버)
  # -------------------------------
  mailhog:
    image: mailhog/mailhog
    container_name: campstation-mailhog
    ports:
      - "1025:1025" # SMTP 포트
      - "8025:8025" # 웹 UI 포트
    networks:
      - campstation-network

# ================================
# Networks
# ================================
networks:
  campstation-network:
    driver: bridge
